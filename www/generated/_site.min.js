"use strict";var app=app||{};app.controls=app.controls||{},app.dialogs=app.dialogs||{},app.site={htmlFiles:{},regexUrlAccount:/\/account\/\d*/,regexUrlLocation:/\/location\/[\w\d%-]*-\d*/,regexUrlStore:/\/store\/\d*/,init:function(e){app.util.preloadImages("/res/svg/",["icon-navbar-active.svg","icon-close-hover.svg"]),this.htmlFiles=e,app.util.setupTemplateFormatters(),app.dialogs.init(),app.routerBase.init(),app.routerBase.loadPageForRoute(null,"site")},onPageChanged:function(e){app.site.navbar.init(e)},normalizeRoute:function(e){var t=!1,o=e;return this.regexUrlStore.exec(e)?(o="/store/:id",t=!0):this.regexUrlLocation.exec(e)?(o="/location/:suburb",t=!0):this.regexUrlAccount.exec(e)&&(o="/account/:id",t=!0),{route:o,match:t}},routes:{"/":{title:"Home",file:"home",initFunction:function(e){app.site.home.init(e)}},"/account/:id":{title:"Account",file:"account",initFunction:function(e){app.site.account.init(e)}},"/about":{title:"About",file:"about",initFunction:function(){}},"/help":{title:"Help",file:"help",initFunction:function(){}},"/location/:suburb":{title:"Location",file:"location",initFunction:function(e){app.site.location.init(e)}},"/store/:id":{title:"Store",file:"store",initFunction:function(e){app.site.store.init(e)}},"/login":{title:"Login",file:"login",initFunction:function(e){app.site.login.init(e)}},"/store-login":{title:"Store Login",file:"login",initFunction:function(e){app.site.login.init(e)}},"/verify-account":{title:"Verify Account",file:"verify-account",initFunction:function(e){app.site.verifyAccount.init(e)}},"/reset-password":{title:"Reset Password",file:"reset-password",initFunction:function(e){app.site.resetPassword.init(e)}},"/register":{title:"Register",file:"login",initFunction:function(e){app.site.login.init(e)}},"/store-application":{title:"Store Application",file:"login",initFunction:function(e){app.site.login.init(e)}}}},app.site.routesList=Object.keys(app.site.routes),app.site.account={init:function(){var e=this;app.util.ajaxRequest({method:"GET",url:"/api/v1/account",auth:!0},function(t,o){t?app.util.invalidateCredentialsAndGoToLogin():(console.log(o),e.afterInit())})},afterInit:function(){$(".page-content").show(),$("#delete-account").on("click",function(){app.util.showLoadingScreen(),app.util.ajaxRequest({method:"GET",url:"/api/v1/delete-user",auth:!0},function(e){app.util.hideLoadingScreen(),e||app.util.invalidateCredentialsAndGoToLogin()})})}},app.dialogs.addToOrder={dialogEl:"#dialog-store-add-to-order",dialogCloseEl:"#dialog-store-add-to-order-close",init:function(e){var t=this;$(this.dialogCloseEl).off().on("click",function(){t.hide()})},show:function(){$("#dialog-container").show(),$(this.dialogEl).show()},hide:function(){$("#dialog-container").hide(),$("#dialog-container > div").hide()}},app.dialogs.checkout={init:function(){},show:function(){$("#dialog-container").show()},hide:function(){$("#dialog-container").hide(),$("#dialog-container > div").hide()}},app.site.home={init:function(){}},app.site.location={suburbs:[],storeData:[],suburbTimeout:null,pageWidth:0,regularHeadingWidth:0,locationHeadingWidth:0,headingContainerWidth:0,typeaheadWidth:0,init:function(e){var t=this;app.util.ajaxRequest({method:"GET",url:"/res/_stores.json"},function(e,o){e||(t.storeData=o,t.afterStoreDataLoaded())});var o=e.route.slice(0);if(0===o.indexOf("/location")){var i=o.replace("/location/","");i=i.split("-"),$("#location-header-location").text(decodeURIComponent(i[0])+" "+i[1])}},afterStoreDataLoaded:function(){for(var e=-1,t="",o=null,i=0;i<this.storeData.length;i++){t=(e=this.storeData[i].stores.length)+(1==e?" Location":" Locations"),$("#location-store-list").append("<div class='row-heading-container'><h3>"+this.storeData[i].category+"</h3><label class='row-heading-label'>"+t+"</label></div><hr />");for(var a=document.createDocumentFragment(),n=0;n<this.storeData[i].stores.length;n++){(o=this.storeData[i].stores[n]).storeId="store"+o.id_store;var s=app.util.loadTemplate("#template-store-list-item",o,o.id_store,"data-store-id");"Open Now"==o.open&&s.find(".store-list-item-text-open").addClass("active"),s.find(".store-list-item-image").css({"background-image":"url("+o.image+")"});for(var r=Math.round(o.avgReview),l=s.find(".rating-control-static > div"),p=0;p<r;p++)$(l[p]).addClass("active");a.append(s[0])}var u=$("<div class='category-stores-row'><div class='category-stores-row-inner'></div></div>");u.find(".category-stores-row-inner").append(a),$("#location-store-list").append(u)}$(".category-stores-row-inner").each(function(e,t){new app.controls.HorizontalScroller(t,function(e){var t=$(e).closest(".store-list-item")[0].id.replace("store","");app.routerBase.loadPageForRoute("/store/"+t,"site")})})}},app.site.login={init:function(e){var t=this;$("#form-login").on("submit",function(){var e=validate.collectFormValues($("#form-login")[0],{trim:!0});return!!app.util.validateInputs(e,app.validationRules.login)&&(app.util.ajaxRequest({method:"POST",url:"/api/v1/login",data:e},function(e,t){if(e)return!1;app.util.addJwtToStorage(t.data.jwt),app.util.addPersonIdToStorage(t.data.id_person),app.routerBase.loadPageForRoute("/account/"+t.data.id_person,"site")}),!1)}),$("#form-store-login").on("submit",function(){var e=validate.collectFormValues($("#form-store-login")[0],{trim:!0});return!!app.util.validateInputs(e,app.validationRules.login)&&(app.util.ajaxRequest({method:"POST",url:"/api/v1/store-login",data:e},function(e,t){if(e)return!1;app.util.addJwtToStorage(t.data.jwt),app.util.addPersonIdToStorage(t.data.id_person),app.util.addStoreIdToStorage(t.data.id_store),window.location.href="/store-admin/"+t.data.id_store+"/dashboard"}),!1)}),$("#form-register").on("submit",function(){if(!$("#checkbox-tnc").is(":checked"))return app.util.showToast("You need to agree to the terms and conditions"),!1;var e=validate.collectFormValues($("#form-register")[0],{trim:!0});return!!app.util.validateInputs(e,app.validationRules.createUser)&&(app.util.ajaxRequest({method:"POST",url:"/api/v1/create-user",data:e},function(o,i){o||(app.util.addJwtToStorage(i.data.jwt),app.util.addPersonIdToStorage(i.data.id_person),$("#registration-success-email").text(e.email),t.showForm("#registration-success"))}),!1)}),$("#form-store-application").on("submit",function(){var e=validate.collectFormValues($("#form-store-application")[0],{trim:!0});return!!app.util.validateInputs(e,app.validationRules.storeApplication)&&(app.util.ajaxRequest({method:"POST",url:"/api/v1/store-application",data:e},function(o){o||($("#store-application-success-email").text(e.email),t.showForm("#store-application-success"))}),!1)}),$("#form-forgot-password").on("submit",function(){return app.util.showToast("not working just yet"),!1}),$("#registration-success-account").on("click",function(){var e=app.util.getPersonIdFromStorage();e?window.location.href="/account/"+e:app.util.showToast("Error : Unable to go to account page")}),$("#store-application-success-home").on("click",function(){window.location.href="/"}),$("#login-goto-register").on("click",function(){t.showForm("#form-register",!0,!0,"Register","register")}),$("#login-goto-store-login").on("click",function(){t.showForm("#form-store-login",!0,!1,"Store-login","store-login")}),$("#store-login-goto-login").on("click",function(){t.showForm("#form-login",!0,!0,"Login","login")}),$("#login-goto-store-application").on("click",function(){t.showForm("#form-store-application",!0,!0,"Store Application","store-application")}),$("#login-forgot-password").on("click",function(){t.showForm("#form-forgot-password")}),$("#register-goto-login").on("click",function(){$("#checkbox-tnc").prop("checked",!1),t.showForm("#form-login",!0,!0,"Login","login")}),$("#store-application-goto-login").on("click",function(){$("#checkbox-tnc-store").prop("checked",!1),t.showForm("#form-login",!0,!0,"Login","login")}),$("#forgot-password-goto-login").on("click",function(){t.showForm("#form-login",!0,!0,"Register","register")}),$(window).on("resize",function(){t.updateFormVisuals()}),setTimeout(function(){t.updateFormVisuals(),"/login"==e.route&&t.showForm("#form-login"),"/store-login"==e.route&&t.showForm("#form-store-login"),"/register"==e.route&&t.showForm("#form-register"),"/store-application"==e.route&&t.showForm("#form-store-application")},500)},showForm:function(e,t,o,i,a){$("#page-login .form-container-outer").addClass("hidden"),$(e).closest(".form-container-outer").removeClass("hidden"),t&&(o?$("#navbar-login").addClass("active"):$("#navbar-login").removeClass("active"),document.title=i,window.history.pushState(null,a,a)),$("html, body").animate({scrollTop:100},200)},updateFormVisuals:function(){$("#page-login form").each(function(e,t){var o=t.clientHeight,i=t.clientWidth,a=$(t).closest(".form-container-outer"),n=$(t).siblings(".form-container-inner");$(a).css({height:o,width:i}),$(n[0]).css({height:o-10,width:i-10}),$(n[1]).css({height:o-10,width:i-10})})}},app.site.navbar={init:function(e){var t=new app.controls.Navbar(e);$(".navbar-links a").removeClass("active");var o=e.route;0===o.indexOf("/location/")||"/register"==o||"/register-store"==o||"/store-login"==o||$(".navbar-link-"+e.file).addClass("active"),app.routerBase.isUserLoggedIn()?($(".navbar-link-logout").show(),$(".navbar-link-account").show(),$(".navbar-link-login").hide(),app.util.getStoreIdFromStorage()&&$(".navbar-link-dashboard").show()):($(".navbar-link-login").show(),$(".navbar-link-logout").hide(),$(".navbar-link-account").hide(),$(".navbar-link-dashboard").hide()),new app.controls.Typeahead(function(e,t){e&&t&&app.routerBase.loadPageForRoute("/location/"+t,"site")}),t.linkClicked=function(e,t){if("blog"==e.target.innerText.toLowerCase())return app.util.showToast("Not working yet"),!1;if("account"==e.target.innerText.toLowerCase())return app.routerBase.loadPageForRoute("/account/"+app.util.getPersonIdFromStorage(),"site"),!1;if("dashboard"==e.target.innerText.toLowerCase()){var o=app.util.getStoreIdFromStorage();return window.location.href="/store-admin/"+o+"/dashboard",!1}return app.routerBase.loadPageForRoute(t,"site"),!1}}},app.site.resetPassword={init:function(){var e=this;this.resetPasswordToken=window.location.search,!this.resetPasswordToken||this.resetPasswordToken.length<30?app.util.showToast("Invalid verification token",4e3):(this.resetPasswordToken=this.resetPasswordToken.substr(3,this.resetPasswordToken.length),$("#form-reset-password").on("submit",function(){var t=validate.collectFormValues($("#form-reset-password")[0],{trim:!0});return t.token=e.resetPasswordToken,!!app.util.validateInputs(t,app.validationRules.resetPassword)&&(app.util.ajaxRequest({method:"POST",url:"/api/v1/reset-password",data:t},function(e){e||app.util.invalidateCredentialsAndGoToLogin()},!0),!1)}))}},app.site.store={init:function(e){var t=this;app.storeContent.init(),this.checkoutHeaderHeight=65,this.$checkout=$("#store-checkout"),this.$checkoutContent=$("#store-checkout-content"),this.$checkoutHide=$("#store-checkout-header-hide"),this.$checkoutShow=$("#store-checkout-header-show");var o=localStorage.getItem("cht");o||(o=screen.height/2-this.checkoutHeaderHeight,localStorage.setItem("cht",o)),this.$checkoutContent.css("height",o);var i=e.route.split("/");i=i[i.length-1],app.storeContent.id_store=i,new app.controls.Resizer("vertical","#store-checkout-resize","#store-checkout-content",this.checkoutHeaderHeight),app.storeContent.getStoreData(function(e){e&&(e.id_store=app.storeContent.id_store,app.storeContent.addStoreDetailsDataToPage(e),app.storeContent.addMenuDataToPage(e))}),$("#store-checkout-header-show").on("click",function(){t.$checkoutContent.show(),t.$checkoutHide.show(),t.$checkoutShow.hide()}),$("#store-checkout-header-hide").on("click",function(){t.$checkoutContent.hide(),t.$checkoutHide.hide(),t.$checkoutShow.show()})}},app.site.verifyAccount={init:function(){var e=this;this.verificationToken=window.location.search,!this.verificationToken||this.verificationToken.length<30?app.util.showToast("Invalid verification token",4e3):(this.verificationToken=this.verificationToken.substr(3,this.verificationToken.length),$("#form-verify-account").on("submit",function(){var t=validate.collectFormValues($("#form-verify-account")[0],{trim:!0});return t.verification_token=e.verificationToken,!!app.util.validateInputs(t,app.validationRules.verifyAccount)&&(app.util.ajaxRequest({method:"POST",url:"/api/v1/verify-account",data:t},function(e,t){e||(t.data.jwt||alert("jwt missing"),app.util.addJwtToStorage(t.data.jwt),app.util.addPersonIdToStorage(t.data.id_person),$("#form-verify-account").addClass("hidden"),$("#verify-account-success").removeClass("hidden"))},!0),!1)}),$("#verify-account-success-account").on("click",function(){var e=app.util.getPersonIdFromStorage();e?window.location.href="/account/"+e:app.util.invalidateCredentialsAndGoToLogin()}),$("#verify-account-success-home").on("click",function(){window.location.href="/"}))}},app.dialogs.businessHours={days:["MON","TUE","WED","THU","FRI","SAT","SUN"],init:function(){var e=this;$("#dialog-store-hours-close").on("click",function(){e.hide()})},update:function(e,t){this.addHoursToList(e.slice(0,7),"#dialog-store-hours-left"),this.addHoursToList(e.slice(7,14),"#dialog-store-hours-right");for(var o="",i=document.createDocumentFragment(),a=0;a<7;a++)o="c"===e[a].opens?"closed":e[a].opens+" to "+e[a].closes,i.append($("<li><span>"+this.days[a]+"</span> "+o+"</li>")[0]);$(t).empty().append(i)},show:function(){app.dialogs.show("#dialog-store-hours")},hide:function(){app.dialogs.hide()}},app.dialogs.description={init:function(){var e=this;$("#dialog-store-description-close").on("click",function(){e.hide()})},update:function(e,t){$("#dialog-store-description-heading").text(e),$("#dialog-store-description-text").text(t)},show:function(){app.dialogs.show("#dialog-store-description")},hide:function(){app.dialogs.hide()}},app.dialogs.init=function(){Object.keys(this).forEach(function(e){app.dialogs[e].init&&app.dialogs[e].init()}),this.$dialogContainer=$("#dialog-container"),this.$dialogs=this.$dialogContainer.children(),this.$dialogContainer.on("click",function(){})},app.dialogs.show=function(e){this.$dialogContainer.show(),$(e).show()},app.dialogs.hide=function(){this.$dialogs.hide(),this.$dialogContainer.hide()},app.dialogs.reviews={init:function(){var e=this;$("#dialog-store-reviews-add-review").on("click",function(){app.util.showToast("not working yet")}),$("#dialog-store-reviews-close").on("click",function(){e.hide()})},update:function(e){$("#dialog-store-reviews-count").text("( "+e.review_count+" )"),app.controls.RatingControls.setValue("#dialog-store-reviews-rating-control",Math.round(e.rating));for(var t=document.createDocumentFragment(),o=0;o<e.reviews.length;o++){var i="<li class='rating-control-star "+(e.reviews[o].rating>.5?"active":"")+"'></li><li class='rating-control-star "+(e.reviews[o].rating>1.5?"active":"")+"'></li><li class='rating-control-star "+(e.reviews[o].rating>2.5?"active":"")+"'></li><li class='rating-control-star "+(e.reviews[o].rating>3.5?"active":"")+"'></li><li class='rating-control-star "+(e.reviews[o].rating>4.5?"active":"")+"'></li>";t.append($("<div class='store-reviews-list-item'><div class='store-reviews-list-item-header'><ul class='rating-control inactive'>"+i+"</ul><label>"+e.reviews[o].title+"</label></div><p>"+e.reviews[o].review+"</p></div>")[0])}$("#dialog-store-reviews-list").empty().append(t)},show:function(){app.dialogs.show("#dialog-store-reviews")},hide:function(){app.dialogs.hide()}},app.i18n={},app.i18n.en={storeIdMissing:"Store Id missing",imageFileMissing:"Image file missing",imageFileWrongType:"Incorrect image type.  Only Jpg is supported",imageFileTooBig:"Image file size too big.  Must be < 250kB"},app.routerBase={firstLoad:!0,lastLoadedSection:"",isLoading:!1,init:function(){document.addEventListener("deviceready",function(){app.cordova.init()},!1)},loadPageForRoute:function(e,t,o){if(!this.isLoading&&window.location.pathname!==e){var i=this;this.isLoading=!0,this.lastLoadedSection=t,$(window).off(),$(document).off(),window.onpopstate=function(){console.log("on popstate "+window.location.pathname),i.loadPageForRoute(window.location.pathname,i.lastLoadedSection,!0)};var a=this.getCurrentRouteData(e,t);return $("#page-container").empty(),$("#page-container").append(a.html),$("html, body").animate({scrollTop:0},200),app[t].routes[a.normalizedRoute].initFunction(a),app[t].onPageChanged(a),$("body").css("display","block"),i.firstLoad||o||a.route!=window.location.pathname&&window.history.pushState(null,a.route,a.route),i.firstLoad=!1,i.isLoading=!1,document.title=a.title,a}},getCurrentRouteData:function(e,t){var o=e||window.location.pathname,i={route:o};if(app.util.isCordova()&&"/index-cordova"==(o=o.substring(o.lastIndexOf("/"),o.length-5))&&(o="/"),i.normalizedRoute=app[t].normalizeRoute(o).route,i.section=t,-1!==app[t].routesList.indexOf(i.normalizedRoute))return i.html=app[t].htmlFiles[i.normalizedRoute],$.extend(i,app[t].routes[i.normalizedRoute]),i;app.util.invalidateCredentialsAndGoToLogin()},logUserOut:function(){app.util.ajaxRequest({method:"GET",url:"/api/v1/logout",auth:!0},function(){app.util.invalidateCredentialsAndGoToLogin()})},isUserLoggedIn:function(){var e=app.util.getJwtFromStorage();return e&&e.length>30}},app.storeContent={storeDataRequestNotAllowed:!1,storeData:{},init:function(){this.$logo=$(".store-info-image"),this.$description=$("#store-info-description"),this.$logoEmpty=$(".store-info-image-empty"),this.$logoLoading=$(".store-info-image-loading"),this.$descriptionButton=$("#store-info-button-description"),this.$menuList=$("#store-menu-list"),this.$logoEmpty.hide(),this.$logoLoading.show(),this.id_store=app.util.getStoreIdFromStorage(),$("#store-info-button-description").on("click",function(){app.dialogs.description.show()}),$("#store-info-button-hours").on("click",function(){app.dialogs.businessHours.show()}),$("#store-info-button-reviews").on("click",function(){app.dialogs.reviews.show()})},resizeDescription:function(){this.$description[0].scrollHeight>this.$description.innerHeight()?this.$descriptionButton.show():this.$descriptionButton.hide()},addStoreDetailsDataToPage:function(e){var t=this,o=new Image;o.src="/res/storelogos/store"+this.id_store+".jpg?"+Date.now(),o.onload=function(){t.$logo.attr("src",o.src),t.$logoEmpty.hide(),t.$logoLoading.hide()},o.onerror=function(){t.$logoLoading.hide(),t.$logoEmpty.show()};var i=e.address[0];i=i.street_address+" "+i.suburb+" "+i.postcode,$("#store-header-name").text(e.name),this.$description.text(e.description),$("#store-info-address").text(i),$("#store-info-phone-number").text(e.phone_number),$("#store-info-email").text(e.email),$("#store-disclaimer").text(e.disclaimer),$("#store-info-review-count").text("( "+e.review_count+" )"),app.controls.RatingControls.setValue("#store-info-rating-control",Math.round(e.rating)),app.dialogs.description.init(e.name,e.description),app.dialogs.businessHours.init(e.hours),app.dialogs.reviews.init(e),$(window).on("resize",function(){t.resizeDescription()})},addMenuDataToPage:function(e){var t=0,o=0,i=null,a=null,n=document.createDocumentFragment();if(e.products){for(e.products[0].name="testest testest testest testestttestest testest testest testestt",e.product_headings[0].title="testest testest testest testestt",e.products[0].options[0].name="testest testest testest testestt",t=0;t<e.products.length;t++){var s=(a=e.products[t]).options[0].price;for(o=0;o<a.options.length;o++)a.options[o].price<s&&(s=a.options[o].price);a.lowestOptionPrice=s,a.gluten_free&&(a.class1="label-gluten-free"),a.vegetarian&&(a.class2="label-vegetarian"),a.delivery_available||(a.class3="label-takeaway");var r=(i=app.util.loadTemplate("#template-store-menu-item",a,a.id_product,"data-product-id")).find(".store-menu-list-item-options > div").first(),l=null,p=a.options.length;for(o=0;o<a.options.length;o++)(l=app.util.loadTemplate("#template-store-menu-option",a.options[o],a.options[o].id_product_option,"data-product-option-id")).css({width:100/p+"%"}),r.append(l[0]);n.append(i[0])}for(t=0;t<e.product_headings.length;t++){var u=e.product_headings[t],c=$(n).find(".store-menu-list-item[data-product-id='"+u.above_product_id+"']");c&&(i=app.util.loadTemplate("#template-store-menu-heading",u,u.id_product_heading,"data-heading-id")).insertBefore(c)}this.$menuList.append(n),$(".store-menu-list-item-details").on("click",function(){$(this).next().addClass("active")}),$(".store-menu-list-item-options-cancel").on("click",function(){$(this).parent().removeClass("active")}),new app.controls.CategoryScroller(e.product_headings)}else this.$menuList.append("No Products")},getStoreData:function(e){var t=this;return this.storeDataRequestNotAllowed?e(this.storeData):!!app.util.validateInputs({id_store:this.id_store},app.validationRules.getStore)&&(this.storeDataRequestNotAllowed=!0,setTimeout(function(){t.storeDataRequestNotAllowed=!1},2e3),void app.util.ajaxRequest({method:"GET",url:"/api/v1/store?id_store="+this.id_store,cache:!0},function(o,i){if(!o)return i.data.hours=i.data.hours[0],t.storeData=i.data,e(t.storeData)}))}},app.util={setupTemplateFormatters:function(){$.addTemplateFormatter({lowestOptionPriceFormatter:function(e){return"From $"+e},priceFormatter:function(e){return"$"+e.toFixed(2)},categoryArrayFormatter:function(e){return e.join(", ")},phoneNumberFormatter:function(e){return"Ph: "+e},deliveryFormatter:function(e){return"Delivery "+e},minOrderFormatter:function(e){return"Min. Order "+e}})},validateInputs:function(e,t){if(!t)return console.log("validate rule undefined"),!1;var o=validate(e,t,{format:"flat"});return!(o&&o.length>0)||(this.showToast(o[0]),!1)},isCordova:function(){return"true"==$("#is-cordova").val()},showToast:function(e,t,o){var i=$("#toasts"),a=$("<p class='"+(o||"")+"'>"+e+"</p>");i.children().length>=5&&i.children().first().animate({opacity:0,bottom:-50},100,function(){$(this).remove()}),i.append(a[0]),i.show(),a.animate({opacity:1,bottom:0},100),setTimeout(function(){i.children().first().animate({opacity:0,bottom:-50},100,function(){$(this).remove()}),0===i.children().length&&i.hide().empty()},t||2e3)},showLoadingScreen:function(){$("#loading-screen").show()},hideLoadingScreen:function(){$("#loading-screen").hide()},toTitleCase:function(e){return e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})},loadTemplate:function(e,t,o,i){var a=$("<div></div>").loadTemplate($(e),t,{isFile:!1});return a=a.children().first().unwrap(),i&&a.attr(i,o),a},addJwtToStorage:function(e){localStorage.setItem("jwt",e)},getJwtFromStorage:function(){return localStorage.getItem("jwt")},addPersonIdToStorage:function(e){localStorage.setItem("pid",e)},getPersonIdFromStorage:function(){return Number(localStorage.getItem("pid"))},addStoreIdToStorage:function(e){localStorage.setItem("sid",e)},getStoreIdFromStorage:function(){return Number(localStorage.getItem("sid"))},invalidateCredentialsAndGoToLogin:function(){localStorage.removeItem("jwt"),localStorage.removeItem("pid"),localStorage.removeItem("sid"),window.location.href="/login"},checkToken:function(e){var t=this,o=this.getJwtFromStorage();if(!(o&&o.length>30))return this.invalidateCredentials(),e("invalid token");this.ajaxRequest({method:"POST",url:"/api/v1/check-token",auth:!0},function(o,i){return o?(console.log(o),t.invalidateCredentials(),e("invalid token")):(t.addJwtToStorage(i.data.jwt),t.addPersonIdToStorage(i.data.id_person),i.data.id_store&&i.data.id_store>0&&t.addStoreIdToStorage(i.data.id_store),e(null))})},preloadImages:function(e,t){for(var o=[],i=0,a=0;a<t.length;a++)o.push(new Image),o[a].src=e+t[a],o[a].onload=function(){++i===o.length&&(o=null)}},uploadImage:function(e,t){if(e&&e.length>0){if(e[0].size>25e4)return void this.showToast("Image file size too big.  Must be < 250kB");var o=new FormData;o.append("logo",e[0]),o.append("id_store",this.getStoreIdFromStorage()),this.ajaxRequest({method:"POST",url:"/api/v1/store-update-logo",auth:!0,isImage:!0,data:o},function(e,o){return!e&&o&&o.data&&o.data.url?t(null,o.data.url):(console.log(e),t("Error uploading image"))})}else this.showToast("Invalid Image")},ajaxRequest:function(e,t){var o=this,i="application/x-www-form-urlencoded; charser=UTF-8";e.isImage&&(i=!1);var a={method:e.method,url:e.url,data:e.data,cache:e.cache||!1,processData:!e.isImage,contentType:i,beforeSend:function(t){e.auth&&t.setRequestHeader("authorization","Bearer "+app.util.getJwtFromStorage())},success:function(e){return t(null,e)},error:function(e){return console.log(e),e&&(e.responseJSON&&e.responseJSON.err?o.showToast(e.responseJSON.err,4e3):o.showToast("Server Error",4e3)),t(e)}};e.dataType&&(a.dataType=e.dataType),$.ajax(a)}},app.validationRules={_sequence_id:{presence:!0,numericality:{onlyInteger:!0,greaterThan:0}},_sequence_id_optional:{numericality:{onlyInteger:!0,greaterThan:0}},_email:{presence:!0,email:!0,length:{minimum:3,maximum:256}},_email_optional:{email:!0,length:{minimum:3,maximum:256}},_phone_number:{presence:!0,length:{minimum:3,maximum:32}},_phone_number_optional:{length:{minimum:3,maximum:32}},_url_link:{presence:!0,length:{maximum:256}},_url_link_optional:{length:{maximum:256}},_bit:{presence:!0,numericality:{onlyInteger:!0,greaterThanOrEqualTo:0,lessThanOrEqualTo:1}},_bit_optional:{numericality:{onlyInteger:!0,greaterThanOrEqualTo:0,lessThanOrEqualTo:1}},_notes_optional:{length:{maximum:256}},_price:{presence:!0,numericality:{greaterThanOrEqualTo:0}},_price_optional:{numericality:{greaterThanOrEqualTo:0}},_quantity:{presence:!0,numericality:{onlyInteger:!0,greaterThan:0}},_latitude_optional:{numericality:{greaterThanOrEqualTo:0}},_longitude_optional:{numericality:{greaterThanOrEqualTo:0}},_addresses_street_address:{presence:!0,length:{maximum:256}},_people_first_name:{presence:!0,length:{minimum:2,maximum:45}},_people_first_name_optional:{length:{minimum:2,maximum:45}},_people_last_name:{presence:!0,length:{minimum:2,maximum:45}},_people_last_name_optional:{length:{minimum:2,maximum:45}},_people_password:{presence:!0,length:{minimum:3,maximum:64}},_people_reset_password_token:{presence:!0,length:64},_people_reset_password_token_optional:{presence:!0,length:64},_people_jwt:{presence:!0,length:{minimum:30,maximum:512}},_people_jwt_optional:{length:{minimum:30,maximum:512}},_people_verification_token:{presence:!0,length:64},_postcodes_postcode:{presence:!0,length:{minimum:1,maximum:6}},_postcodes_suburb:{presence:!0,length:{minimum:1,maximum:64}},_postcodes_state:{presence:!0,length:{minimum:1,maximum:32}},_reviews_title:{presence:!0,length:{minimum:2,maximum:128}},_reviews_review_optional:{length:{maximum:512}},_reviews_rating:{presence:!0,numericality:{onlyInteger:!0,greaterThan:0,lessThan:6}},_stores_name:{presence:!0,length:{maximum:512}},_stores_description_optional:{length:{maximum:1024}},_stores_abn:{presence:!0,length:{minimum:10,maximum:32}},_stores_bank_name:{presence:!0,length:{minimum:2,maximum:128}},_stores_bank_bsb:{presence:!0,length:{minimum:6,maximum:16}},_stores_bank_account_name:{presence:!0,length:{minimum:2,maximum:128}},_stores_bank_account_number:{presence:!0,length:{minimum:2,maximum:32}},_stores_hours:{length:{maximum:5}},_product_extras_name:{presence:!0,length:{maximum:32}},_product_options_name:{presence:!0,length:{maximum:32}},_products_name:{presence:!0,length:{maximum:64}},_products_description_optional:{length:{maximum:256}},_order_products_customer_notes_optional:{length:{maximum:256}},_orders_notes_optional:{length:{maximum:256}},_orders_expiry:{presence:!0,datetime:!0},_transactions_commission:{presence:!0,numericality:{greaterThanOrEqualTo:0,lessThanOrEqualTo:1e3}},_transactions_processing_fee:{presence:!0,numericality:{greaterThanOrEqualTo:0,lessThanOrEqualTo:1e3}}},app.validationRules.login={email:app.validationRules._email,password:app.validationRules._people_password},app.validationRules.createUser={first_name:app.validationRules._people_first_name,last_name:app.validationRules._people_last_name,email:app.validationRules._email,password:app.validationRules._people_password,confirmPassword:{equality:"password"}},app.validationRules.storeApplication={name:{presence:!0,length:{maximum:128}},email:app.validationRules._email,message:{length:{maximum:256}}},app.validationRules.forgotPassword={email:app.validationRules._email},app.validationRules.verifyAccount={email:app.validationRules._email,password:app.validationRules._people_password,verification_token:app.validationRules._people_verification_token},app.validationRules.resetPassword={email:app.validationRules._people_email,password:app.validationRules._people_password,confirmPassword:{equality:"password"},reset_password_token:app.validationRules._people_reset_password_token},app.validationRules.createStore={postcode:app.validationRules._postcodes_postcode,suburb:app.validationRules._postcodes_suburb,street_address:app.validationRules._addresses_street_address,first_name:app.validationRules._people_first_name,last_name:app.validationRules._people_last_name,phone_number_user:app.validationRules._phone_number,email_user:app.validationRules._email,password:app.validationRules._people_password,name:app.validationRules._stores_name,abn:app.validationRules._stores_abn,internal_notes_store:app.validationRules._notes_optional},app.validationRules.deleteStore={id_store:app.validationRules._sequence_id},app.validationRules.updateStoreDetails={description:app.validationRules._stores_description_optional,street_address:app.validationRules._addresses_street_address,postcode:app.validationRules._postcodes_postcode,suburb:app.validationRules._postcodes_suburb,phone_number:app.validationRules._phone_number,email:app.validationRules._phone_email,hours_mon_dinein_open:app.validationRules._stores_hours,hours_tue_dinein_open:app.validationRules._stores_hours,hours_wed_dinein_open:app.validationRules._stores_hours,hours_thu_dinein_open:app.validationRules._stores_hours,hours_fri_dinein_open:app.validationRules._stores_hours,hours_sat_dinein_open:app.validationRules._stores_hours,hours_sun_dinein_open:app.validationRules._stores_hours,hours_mon_dinein_close:app.validationRules._stores_hours,hours_tue_dinein_close:app.validationRules._stores_hours,hours_wed_dinein_close:app.validationRules._stores_hours,hours_thu_dinein_close:app.validationRules._stores_hours,hours_fri_dinein_close:app.validationRules._stores_hours,hours_sat_dinein_close:app.validationRules._stores_hours,hours_sun_dinein_close:app.validationRules._stores_hours,hours_mon_delivery_open:app.validationRules._stores_hours,hours_tue_delivery_open:app.validationRules._stores_hours,hours_wed_delivery_open:app.validationRules._stores_hours,hours_thu_delivery_open:app.validationRules._stores_hours,hours_fri_delivery_open:app.validationRules._stores_hours,hours_sat_delivery_open:app.validationRules._stores_hours,hours_sun_delivery_open:app.validationRules._stores_hours,hours_mon_delivery_close:app.validationRules._stores_hours,hours_tue_delivery_close:app.validationRules._stores_hours,hours_wed_delivery_close:app.validationRules._stores_hours,hours_thu_delivery_close:app.validationRules._stores_hours,hours_fri_delivery_close:app.validationRules._stores_hours,hours_sat_delivery_close:app.validationRules._stores_hours,hours_sun_delivery_close:app.validationRules._stores_hours},app.validationRules.getStore={id_store:app.validationRules._sequence_id},app.validationRules.validateHours=function(e){if(!e||0===Object.keys(e).length)return"Data missing";for(var t=null,o=null,i=Object.keys(e),a=0;a<i.length;a++)if(0===i[a].indexOf("hours_"))if(e[i[a]]){if(5!==e[i[a]].length||!e[i[a]].match(/\d{2}:\d{2}/))return o=(t=i[a].split("_"))[1]+" "+t[2]+" "+t[3],"Error in Hours "+(o=app.util.toTitleCase(o))+".  Must be HH:MM"}else{var n="open"===(t=i[a].split("_"))[3]?"close":"open";if(o=t[1]+" "+t[2]+" "+t[3],o=app.util.toTitleCase(o),e[t=t[0]+"_"+t[1]+"_"+t[2]+"_"+n])return"Error in Hours "+o+".  Open and Close must be both times or both closed"}return null},app.controls.CategoryScroller=function(e){var t=$("html"),o=".category-scroller-list",i=$(".category-scroller-container"),a=$(".category-scroller"),n=$(o),s=[],r=$(".store-menu-list-item.heading"),l=($(".category-scroll-blur-left"),$(".category-scroll-blur-right"),0),p=[];function u(){p=[],r.each(function(){p.push(this.getBoundingClientRect().top+t.scrollTop())})}function c(){var e=t.scrollTop();for(l=p.length-1;l>=0;l--)if(e>p[l]-100){s.removeClass("active"),$(s[l]).addClass("active");break}}function d(){console.log(n)}var h=document.createDocumentFragment();for(l=0;l<e.length;l++){var m=$("<li class='store-menu-nav-list-item'>"+e[l].title+"</li>");m.on("click",function(e){var o=$(".store-menu-list-item.heading:contains('"+e.target.innerText+"')"),i=80;screen.width<670&&(i=110),o[0]&&$("html").animate({scrollTop:o[0].getBoundingClientRect().top+t.scrollTop()-i},500)}),h.append(m[0])}n.append(h),new app.controls.HorizontalScroller(o,function(){}),$(window).on("scroll",function(){s.length&&(i[0].getBoundingClientRect().top<20?a.addClass("floating"):a.removeClass("floating"),c())}),$(window).on("resize",function(){u(),c(),d()}),s=$(".store-menu-nav-list-item"),u(),d()},app.controls.Navbar=function(){var e=this;$(".navbar a").on("click",function(t){if("logout"==this.innerText.toLowerCase())return app.routerBase.logUserOut(),!1;var o=this.href.replace(window.location.origin,"");return e.linkClicked(t,o),!1}),$(".navbar-links-popup-button").on("click",function(){$(".navbar-links-popup").animate({right:0},200)}),$(".navbar-links-popup-close").on("click",function(){$(".navbar-links-popup").animate({right:-250},200)}),$(".navbar-icon").on("click",function(e){e.ctrlKey?window.location.href="/admin-login":window.location.href="/location/Balmoral-4171"})},app.controls.Navbar.prototype.linkClicked=function(){},app.controls.RatingControls={setValue:function(e,t){for(var o=$(e),i=0;i<t;i++)o.children().eq(i).addClass("active")},getValue:function(e){return $(e+" .rating-control-star.active").length},updateRatingControls:function(e){for(var t=0;t<e.length;t++)if(e[t].id_review)for(var o=$(".rating-control-stars.user[data-id='"+e[t].id_review+"']"),i=0;i<e[t].rating;i++)o.children().eq(i).addClass("active")},recreateRatingControlEvents:function(){$(".rating-control-star").off(),$(".rating-control-star").unbind();var e=!1;$(".rating-control-star").on("click",function(){$(this).hasClass("active")||$(this).siblings().hasClass("active")||(e=!0),console.log(e),$(this).removeClass("active"),$(this).siblings().removeClass("active"),$(this).addClass("active"),$(this).prevAll().addClass("active")})}},app.controls.Resizer=function(e,t,o,i){var a=$(t),n=$(o),s=0,r=0,l=!1;a.on("mousedown",function(e){l=!0,s=e.clientX,r=e.clientY,console.log(s,r)}),$(window).on("mousemove",function(e){if(e.preventDefault(),e.stopPropagation(),l){var t=window.innerHeight-e.clientY-i;n.height(t)}}),$(window).on("mouseup",function(){l=!1})},app.controls.HorizontalScroller=function(e,t){var o=!1,i=0,a=0;$(e).on("mousedown",function(e){o=!0,i=e.clientX,a=$(this).scrollLeft()}),$(window).on("mousemove",function(t){o&&(t.stopPropagation(),$(e).scrollLeft(a-(t.clientX-i)))}),$(window).on("mouseup",function(){o=!1}),$(e).on("mouseup",function(e){var o=e.clientX-i;o>=-4&&o<=4&&t(e.target)})},app.controls.Typeahead=function(e){var t=this;this.$typeaheadInput=$("#typeahead-suburb-search"),this.$typeaheadList=$("#typeahead-suburb-list");var o=null;function i(o){var i={suburb:$(o).find(".typeahead-item-suburb").text(),postcode:$(o).find(".typeahead-item-postcode").text()};if(t.$typeaheadList.hide(),t.$typeaheadInput.attr("data-suburb",""),t.$typeaheadInput.attr("data-postcode",""),!i.suburb||!i.postcode)return e(null);t.setValue(i.postcode,i.suburb);var a=encodeURIComponent(i.suburb+"-"+i.postcode);return e(i,a)}this.baseUrl="/api/v1/location?q=",this.$typeaheadList.on("click",function(e){i(e.target)}),this.$typeaheadInput.on("focus",function(){this.setSelectionRange(0,this.value.length)}),this.$typeaheadInput.on("blur",function(){var e=t.getValue();e.suburb&&e.postcode?(console.log("1"),t.setValue(e.postcode,e.suburb)):(t.$typeaheadInput.attr("data-suburb",""),t.$typeaheadInput.attr("data-postcode",""),t.$typeaheadInput.val(""))}),this.$typeaheadInput.on("keyup",function(e){var a=0,n=[],s=$(this).val().toLowerCase();if(27!=e.which)if(13!=e.which)if(38!=e.which)if(40!=e.which)clearTimeout(o),o=setTimeout(function(){if(s){var e=t.baseUrl+s;app.util.ajaxRequest({method:"GET",url:e},function(e,o){if(!e){var i=[];for(a=0;a<o.data.length;a++)i.push("<li class='typeahead-item'><label class='typeahead-item-postcode'>"+o.data[a].postcode+"</label><span>♔</span><label class='typeahead-item-suburb'>"+app.util.toTitleCase(o.data[a].suburb)+"</label></li>");t.$typeaheadList.empty(),i.length>0?(t.$typeaheadList.append(i.join("")),t.$typeaheadList.show()):(t.$typeaheadList.show(),t.$typeaheadList.append("<li class='typeahead-item'>NO RESULTS</li>"))}})}else t.$typeaheadList.hide()},500);else for(n=$(".typeahead-item"),a=n.length-1;a>=0;a--){if($(n[a]).hasClass("active")){$(n[a]).removeClass("active"),$(n[a]).next().addClass("active");break}0==a&&$(n[0]).addClass("active")}else for(n=$(".typeahead-item"),a=0;a<n.length;a++){if($(n[a]).hasClass("active")){$(n[a]).removeClass("active"),$(n[a]).prev().addClass("active");break}a==n.length-1&&$(n[n.length-1]).addClass("active")}else{var r=$(".typeahead-item.active");r.length>0&&i(r[0])}}),$(window).on("mousedown",function(e){"typeahead-item"!=e.target.className&&t.$typeaheadList.hide()}),$(window).on("keydown",function(e){27==e.which&&t.$typeaheadList.hide()})},app.controls.Typeahead.prototype.setValue=function(e,t){this.$typeaheadInput.val(e+" - "+t),this.$typeaheadInput.attr("data-suburb",t),this.$typeaheadInput.attr("data-postcode",e)},app.controls.Typeahead.prototype.getValue=function(){return{suburb:this.$typeaheadInput.attr("data-suburb"),postcode:this.$typeaheadInput.attr("data-postcode")}};