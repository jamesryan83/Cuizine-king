
Notes on what's in the codebase and what it does


## General notes

There are 3 database for the project.  One test, one dev and one live.

The website is split into 3 sections:
    Website - The part that public website users see.
    CMS - (Content management system) The store admin section.
    System - for us to manage the overall website, database etc.

Each section is a single page app.  When you go to a new section it makes
a new page request.  All other requests are api requests.




## Security and access control

jwt's (json web tokens) are used for all security.  The jwt contains
the users id (id_person).  On a request for a restricted resource the
jwt is checked against the secret and then against the persons
database record (id_person and jwt).  Jwts have a long and short expiry.
They are refreshed after the short expiry.  Client side, the jwt is kept in
local storage.

In the table /sql/tables/App/people.sql are 3 columns, is_web_user,
is_store_user and is_system_user.  These control access to different
resources.  System users have access to system/store/website stuff,
store users have access to store/website stuff and website users only
have access to website stuff.

/server/other/passport-auth.js handles the jwt authentication.





## App folder
A cordova app.  It uses the same code as the client side of the website.



## /Data folder

The data is for the database and for client side ajax requests.
The postcode data is real data but all the rest is made up data.

/data/pages
    temporary fake data for when developing website pages.  Used from ajax
    when the database for that page isn't set up yet.

/data/postcodes
    all the postcode data for the database

/data/stores
    all the fake store and address data

/data/Fakedata.xlsm and FakedataTest.xlsm
    This contain worksheets that match the database tables.  Fakedata.xlsm
    has lots of data and FakedataTest.xlsm has only minimal data for testing.
    Fakedata.xlsm contains a VBA macro that generates *.sql scripts.  The
    macro turns the data in the worksheets into a bunch of INSERT statements.
    FakedataTest.xlsm has no macros, the sheets are accessed from Fakedata.xlsm

/data/Fakedata-run.vbs
    A visual basic script that calls the macro in Fakedata.xlsm to
    generate all the seed data from both *.xlsm files into
    the /sql/generated/seed folder.




## /Gulp folder

Gulp is used to create all the generated files and compile scss to css.
It does html, css, js and sql files


/gulp/generate-html.js
    There is 3 json files created, one for each section of the website
    which are then loaded client side.

/gulp/generate-js.js
    joins javascript files together.  Adds "use strict" and var app = app || {}
    to the top of the joined files.  There's 3 js files created, one for each section

/gulp/generate-sql-create.js
    creates all the files in the /sql/generated folder, not the seed folder though,
    that's from excel

/gulp/generate-sql-js.js
    generates functions used to call the sql stored procedures.  The generated
    files are in /server/procedures

/gulp/gulp-all.bat
    used in the node-webkit program.  just runs "gulp all"

/gulp/gulpfile.js
    a regular gulp file used to run all the other js files in this folder.
    The gulpfile has the scss stuff too.




## /Server folder

This is the node.js server.  Currently there is only 1 server for the whole
project

/server/api
    These call the database and perform other operations.  They're called
    from /server/other/router.js

/server/database
    explained below

/server/other
    files that don't fit into the other folders

/server/procedures
    these are the functions used to call the stored procedures.  They're generated
    by gulp.




## /Server/Database folder

There are 3 databases for the project.  The dev and azure databases are
called Menuthing, and the Test database is called MenuthingTest.
MenuthingTest is only used by the unit tests.  Dev is used for local
development. Azure is the live production database.

All the database SQL code is in the /sql folder

/sql/batchfiles
    These run multiple *.sql scripts using SqlCmd.  There are batch
    files for creating a new database and resetting the database to a clean state

/sql/generated
    files generated by gulp.  These can be run in SSMS or by SqlCmd.  The batch
    files run these.

/sql/generated/seed
    The seed data is generated in the excel workbooks in the data folder

/sql/other
    database files that don't really go in the other folders

/sql/procedures
    all the stored procedures.  Gulp joins these together and also generates
    javascript files from them

/sql/tables
    all the database tables.  Gulp joins these together




## /Tests folder

The database and api tests use mocha, supertest and the default node assert library.

There is no UI testing yet.




## /tools folder

This is a node-webkit desktop app.  It's for performing system tasks like
creating a new store.  Currently it's performing the same role as the system
section of the website.  Not sure which one is best to use, probably the
desktop app for secrutiy reasons.




## /www folder

This is all the client side webste code.

The index-main.html is the first file sent for a page request.  The ajax in
that file makes a request for the content in the generated folder for
the section of the website required.



## How the server works

The node server doesn't start listening until after the database is connected.
After that it just processes requests until it crashes.  Azure will restart the server




## How pages work on the website

Local Storage

sid - id_store
pid - id_person
jwt - json web token
cht - checkout height
cop - checkout open

Session Storage

cod - checkout data




## Files of interest

Files that start with underscores (except the scss ones) are generated by gulp

IISNode.yml
    settings for IISNode on Azure
    https://github.com/Azure-Samples/app-service-web-nodejs-get-started/blob/master/iisnode.yml

nodemon.json
    files/folders that nodemon will ignore changes in and won't restart the server.
    nodemon is used for dev only.  Azure restarts the server on it's own

web.config
    usually generated by azure, but we need it because server.js is in the
    src folder and not the root folder, so had to change some paths

server/config.json
    main config file for the server

server/other/passport-auth.js
    sets up the passport jwt strategy
    http://passportjs.org/

www/js/site.js, www/js/cms.js, www/js/sysadmin.js
    the main js files for the different sections of the site.  They contain the routes

www/js/shared/validation-rules.js
    mostly for validating api route stuff, like when a form is posted etc
    works client and serverside


